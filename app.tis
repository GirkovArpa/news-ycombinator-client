include "sciter:reactor.tis";
import { api } from 'main.tis';

class App : Reactor.Component {
  this var items = [];

  attached(){
    this.update { items:await api.fetchTopStories() }
  }
  
  event comment-click (evt){
    const commentIds = evt.data.kids;
    this.update { items: [evt.data.parentItem], loading: true };
    api.fetchComments(commentIds).then((comments) => {
      this.update {items: [...this.items, ...comments], loading: false};
    });    
  }

  render() {
    return <div #root>
      <div .banner>
        <b>Hacker News</b>
        {(!this.items.length || this.loading) ? <img .spinner src="sciter:busy.png"/> : ""}
      </div>
      { this.items.map((item) => <Item item={item} />) }
    </div>;
  }
}

class Item : Reactor.Component {

  function this(props) {
    //one way to expand props
    this.extend(props);
  }

  render() {
    return this.item.type === "comment" ? <Comment item={this.item} /> : <TopStory item={this.item} />;
  }
}

class TopStory : Reactor.Component {
  this var item;
  
  function this(props) {
    //better way to expand props for readability
    this.item = props.item;
  }

  event click $(#comment) (evt, el) {
    //let the handling of state change to parent.
    this.postEvent('comment-click', {parentItem: this.item, kids: this.item.kids});
  }

  render() {
    const { url, type, title, time, score, kids, id, descendants, by } = this.item;
    const urlShort = url.match(/https?:\/\/([\w\.]+)/)[1];
    return <li .story>
      <div .title>
        <span .title>{title}</span>
        <ExternalLink urlShort={urlShort} url={urlShort} />
      </div>
      <div .details>
        <span .score>{score} points by</span>
        <span .author>{by}</span>
        <span .ago>{Date.diff(new Date(time*1000.00), new Date(), #hours)} hours ago</span>|
        <span .hide>hide</span>|
        <span .kidCount #comment>{descendants} comments</span>
      </div>
    </li>;
  } 
}

class ExternalLink : Reactor.Component {
  function this(props) {
    this.props = props;
  }
  event click {
    Sciter.launch(this.props.url);
  }

  render() {
    return <span .url>{this.props.urlShort}</span>;
  }
}

class Comment : Reactor.Component {
  function this(props) {
    this.props = props;
  }
  
  render() {
    const { text, url, type, title, time, score, kids, id, descendants, by } = this.props.item;
    return <li .comment>
      <div .details .comment>
        <span .author>{by}</span>
         <span .ago>{Date.diff(new Date(time*1000.00), new Date(), #hours)} hours ago</span>
      </div>
      <div .title>
        <CommentText comment={text} />
      </div>
    </li>;
  }
}

class CommentText : Reactor.Component {
  function this(props) {
    this.props = props;
  }
  
  render() {
    const div = <div .comment-text></div>;
    this.html = this.props.comment;
    return div;
  }
}

$(.notice > a) << event click {
  Sciter.launch(this.attributes["href"]);
  return true;
};